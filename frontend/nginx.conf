resolver 127.0.0.11 valid=30s;

server {
    listen 80;
    server_name localhost;

    root /usr/share/nginx/html;
    index index.html;

    # CORS headers
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization' always;

    location / {
        try_files $uri $uri/ /index.html;
    }

    # Proxy API calls to backend services
    location /api/patient {
        set $upstream http://patient-service:8001;
        # Handle paths that already include /v1
        rewrite ^/api/patient/v1/(.*) /v1/$1 break;
        # Handle other paths (add /v1)
        rewrite ^/api/patient/(.*) /v1/$1 break;
        proxy_pass $upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /api/doctor {
        set $upstream http://doctor-service:8002;
        # Handle paths that already include /v1
        rewrite ^/api/doctor/v1/(.*) /v1/$1 break;
        # Handle other paths (add /v1)
        rewrite ^/api/doctor/(.*) /v1/$1 break;
        proxy_pass $upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Handle actuator endpoints FIRST (regex match - must come before prefix match)
    location ~ ^/api/appointment/actuator {
        set $upstream http://appointment-service:8003;
        rewrite ^/api/appointment/actuator/(.*) /actuator/$1 break;
        proxy_pass $upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /api/appointment {
        set $upstream http://appointment-service:8003;
        # Handle v1 API endpoints
        rewrite ^/api/appointment/v1/(.*) /v1/$1 break;
        # Fallback for other paths (add /v1) - but skip actuator (handled above)
        rewrite ^/api/appointment/(.*) /v1/$1 break;
        proxy_pass $upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /api/billing {
        set $upstream http://billing-service:8004;
        rewrite ^/api/billing/(.*) /v1/$1 break;
        proxy_pass $upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}


